<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fondo Famipardo - Cloud V3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .chat-content strong { font-weight: 700; color: #312e81; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-900 text-white p-2 flex items-center justify-between shadow-md z-50 flex-shrink-0">
        <div class="flex items-center gap-4 px-4">
            <span class="font-bold text-sm tracking-wider text-gray-400">FONDO FAMIPARDO</span>
            <div class="h-4 w-px bg-gray-700"></div>
            <span id="current-view-name" class="text-sm font-medium text-white">Cargando...</span>
        </div>
        <div class="flex gap-2 items-center overflow-x-auto no-scrollbar" id="nav-buttons"></div>
    </nav>

    <main id="app-container" class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col justify-center items-center">
        <div class="text-center space-y-4">
            <div class="animate-spin text-indigo-600"><i data-lucide="loader-2" width="40" height="40"></i></div>
            <div class="text-indigo-600 font-bold animate-pulse">Conectando a la Nube...</div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // TU CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDLxG35sVR6zs8yyrkNL4mOVQMuGeavM9U",
            authDomain: "-famipardo.firebaseapp.com",
            projectId: "-famipardo",
            storageBucket: "-famipardo.firebasestorage.app",
            messagingSenderId: "839962195396",
            appId: "1:839962195396:web:4e5a3e1448d55656672091",
            measurementId: "G-GVVEB0V65Y"
        };

        // INICIALIZAR FIREBASE
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DATOS INICIALES (Para subir a la nube la primera vez)
        const initialUsers = [
            { id: '1010', name: 'Juan Perez', aportes: 2000000, deuda: 500000, multas: 0 },
            { id: '1020', name: 'Maria Rodriguez', aportes: 3500000, deuda: 0, multas: 50000 },
            { id: '1030', name: 'Carlos Gomez', aportes: 1000000, deuda: 1200000, multas: 0 }
        ];

        // ESTATUTOS (Base de Conocimiento)
        const statutesDatabase = [
            { id: 'art1', article: 'ART√çCULO 1', title: 'Finalidad', content: 'El presente  tiene como finalidad fomentar el h√°bito del ahorro y brindar apoyo a sus asociados.' },
            { id: 'art4', article: 'ART√çCULO 4', title: 'Capital', content: 'El capital se constituir√° de: a) Aportes obligatorios de los asociados. b) Utilidades y cualquier ingreso acumulado.' },
            { id: 'art15', article: 'ART√çCULO 15', title: 'Pr√©stamos', content: 'Cupo de cr√©dito: 100% de los aportes. Inter√©s 0.5% mensual (0.8% mora). Se pueden solicitar nuevos cr√©ditos consolidando la deuda.' },
            { id: 'art16', article: 'ART√çCULO 16', title: 'Sanciones', content: 'Se multar√° con el valor de la cuota de afiliaci√≥n al asociado que no asista a las reuniones. Prelaci√≥n de pagos: 1.Sanciones 2.Intereses 3.Deuda.' },
            { id: 'art5', article: 'ART√çCULO 5', title: 'Ingreso', content: 'Cuota de admisi√≥n: 2 veces el aporte obligatorio.' }
        ];

        // VARIABLES GLOBALES
        let currentUser = null;
        let currentView = 'login';
        window.activeCat = 'General';

        // UTILIDADES
        const f = (num) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(num);
        const normalizeText = (text) => text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const parseAmount = (text) => {
            const clean = text.toLowerCase().replace(/\./g, '').replace(/,/g, '');
            let m = 1;
            if (clean.includes('millon')) m = 1000000; else if (clean.includes('mil') || clean.includes('k')) m = 1000;
            const match = clean.match(/(\d+)/);
            return match ? parseInt(match[0]) * m : 0;
        };

        // --- L√ìGICA DE FIREBASE (SEMBRADO Y LOGIN) ---
        async function initSystem() {
            try {
                // Verificar conexi√≥n intentando leer un usuario
                const testRef = doc(db, "socios", "1010");
                const testSnap = await getDoc(testRef);

                if (!testSnap.exists()) {
                    console.log("Base de datos nueva. Subiendo usuarios...");
                    for (const u of initialUsers) {
                        await setDoc(doc(db, "socios", u.id), u);
                    }
                    console.log("Usuarios creados en la nube.");
                }
                renderLogin(document.getElementById('app-container'));
                document.getElementById('current-view-name').textContent = "Login";
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n con Firebase. Revisa la consola.");
            }
        }

        window.login = async function() {
            const id = document.getElementById('login-id').value.trim();
            if (!id) return;
            
            const btn = document.getElementById('login-btn');
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            
            try {
                const docRef = doc(db, "socios", id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUser = docSnap.data();
                    switchView('dashboard');
                } else {
                    alert("Usuario no encontrado en la nube. Prueba 1010.");
                    btn.textContent = "Ingresar";
                }
            } catch (e) {
                alert("Error al ingresar: " + e.message);
                btn.textContent = "Ingresar";
            }
        };

        window.logout = function() { currentUser = null; switchView('login'); };

        // --- CEREBRO IA ---
        function generateAIResponse(query) {
            const qClean = normalizeText(query);

            // 1. FINANCIERO
            if (currentUser) {
                // Multas
                if (qClean.includes('multa') || qClean.includes('sancion')) {
                    if (qClean.includes('tengo') || qClean.includes('mis') || qClean.includes('debo')) {
                        return currentUser.multas > 0 
                            ? { text: `‚ö†Ô∏è **S√≠, tienes una multa.**\n\nValor pendiente: **$${f(currentUser.multas)}** (Dato de la Nube).`, citations: ['Estado de Cuenta'] }
                            : { text: `‚úÖ **Est√°s al d√≠a.**`, citations: ['Estado de Cuenta'] };
                    }
                }
                // Deuda
                if (qClean.includes('deuda') || qClean.includes('debo')) {
                    if (currentUser.deuda === 0) return { text: "‚úÖ **Est√°s libre de deudas.**", citations: ['Tu Perfil'] };
                    const intereses = currentUser.deuda * 0.005;
                    return { text: `üìâ **Estado de tu Deuda**\n\nCapital: **$${f(currentUser.deuda)}**.\nIntereses (0.5%): **$${f(intereses)}**.\nTotal: **$${f(currentUser.deuda + intereses)}**.`, citations: ['Estado de Cuenta'] };
                }
                // Solicitud
                if (qClean.includes('solicitar') || qClean.includes('pedir') || qClean.includes('prestamo')) {
                    const cupoDisp = (currentUser.aportes * 1) - currentUser.deuda;
                    const monto = parseAmount(query);
                    if (monto > 0) {
                        return monto <= cupoDisp 
                            ? { text: `‚úÖ **S√≠ es posible.**\n\nTu cupo es **$${f(cupoDisp)}** y pides **$${f(monto)}**.`, citations: ['C√°lculo'] }
                            : { text: `‚ùå **No es posible.**\n\nTu cupo m√°ximo es **$${f(cupoDisp)}**.`, citations: ['Cupo Excedido'] };
                    }
                    return { text: `Tienes un cupo disponible de **$${f(cupoDisp)}**.`, citations: ['Estado de Cuenta'] };
                }
                // Capital
                if (qClean.includes('aporte') || qClean.includes('capital') || qClean.includes('ahorro')) {
                    return { text: `üí∞ **Tus Aportes**\n\nCapital ahorrado: **$${f(currentUser.aportes)}**.`, citations: ['Estado de Cuenta'] };
                }
            }

            // 2. ESTATUTOS (B√∫squeda mejorada con slice(0,1))
            const results = searchEngine(query);
            if (results.length > 0) {
                const topMatches = results.slice(0, 1); // <--- TU CORRECCI√ìN AQU√ç
                const text = topMatches.map(m => `‚Ä¢ Seg√∫n **${m.article}** (${m.title}): "${m.content}"`).join('\n');
                return { text: text, citations: topMatches.map(m => m.title) };
            }

            return { text: "No encontr√© esa informaci√≥n. Intenta preguntar por 'mis aportes' o 'art√≠culo 15'.", citations: [] };
        }

        function searchEngine(query) {
            if (!query) return [];
            const results = statutesDatabase.map(item => {
                let score = 0;
                const text = normalizeText(item.title + ' ' + item.content + ' ' + item.article);
                const terms = normalizeText(query).split(' ').filter(t => t.length > 3
